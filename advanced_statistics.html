<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ship Statistics Generator</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .text-json {
            font-family: 'Courier New', Courier, monospace;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-8">

    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-10">
        <div class="relative mb-6 pt-8">
            <a href="/Classic-Traveller-Starship-Designer/" class="absolute top-0 left-0 text-indigo-600 hover:text-indigo-800 font-semibold text-sm sm:text-base px-2 py-1 rounded-md bg-indigo-100 hover:bg-indigo-200 transition-colors duration-200">
                Start Over
            </a>
            <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-indigo-600">
                Ship Statistics Generator
            </h1>
            <a href="programs.html" class="absolute top-0 right-0 text-indigo-600 hover:text-indigo-800 font-semibold text-sm sm:text-base px-2 py-1 rounded-md bg-indigo-100 hover:bg-indigo-200 transition-colors duration-200">
                Open Programs Information
            </a>
        </div>
        <p class="text-center text-gray-600 mb-8">
            Enter your ship's JSON configuration below and click the button to calculate advanced combat statistics.
        </p>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Input JSON Section -->
            <div class="flex flex-col lg:col-span-1">
                <label for="json-input" class="block text-xl font-semibold text-gray-700 mb-2">
                    Ship Configuration JSON
                </label>
                <textarea id="json-input" rows="15" class="text-json w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200 resize-none bg-gray-900 text-green-400"></textarea>
                <button id="calculate-btn" class="mt-4 w-full px-6 py-3 bg-indigo-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all duration-300 transform hover:scale-105">
                    Calculate Statistics
                </button>
                <button id="add-room-btn" class="mt-4 w-full px-6 py-3 bg-green-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all duration-300 transform hover:scale-105">
                    Add Additional Room
                </button>
            </div>

            <!-- Middle Column: Output Statistics Section -->
            <div class="flex flex-col lg:col-span-1">
                <label for="json-output" class="block text-xl font-semibold text-gray-700 mb-2">
                    Derived Statistics (JSON)
                </label>
                <textarea id="json-output" rows="15" class="text-json w-full p-4 border border-gray-300 rounded-lg bg-gray-900 text-green-400 focus:outline-none resize-none" readonly></textarea>
                <div id="message-box" class="mt-4 p-4 rounded-lg text-sm transition-opacity duration-300 opacity-0" role="alert"></div>
            </div>

            <!-- Right Column: Armor Reference Table -->
            <div class="flex flex-col lg:col-span-1">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">Armor Reference</h2>
                <div class="bg-gray-50 rounded-lg border border-gray-300 p-4 overflow-y-auto max-h-[600px]">
                    <table class="w-full text-sm">
                        <thead class="sticky top-0 bg-gray-100 border-b-2 border-gray-300">
                            <tr>
                                <th class="text-left py-2 px-2">Grade</th>
                                <th class="text-right py-2 px-2">Points</th>
                                <th class="text-right py-2 px-2">Mass (t)</th>
                                <th class="text-right py-2 px-2">Small (t)</th>
                                <th class="text-right py-2 px-2">Cost (MCr)</th>
                            </tr>
                        </thead>
                        <tbody id="armor-table-body" class="divide-y divide-gray-200">
                            <!-- Armor rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                    <div class="mt-4 p-3 bg-blue-50 rounded-md border border-blue-200">
                        <p class="text-xs text-blue-800">
                            <strong>Note:</strong> Default armor is free. Only upgrades above default have cost/mass.
                        </p>
                        <p class="text-xs text-blue-800 mt-2">
                            <strong>Small ships:</strong> Ships under 100 tons use the "Small (t)" mass column.
                        </p>
                        <p class="text-xs text-blue-800 mt-2">
                            <strong>Military grades:</strong> R-Z are typically not available for civilian purchase.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Derived Stats Summary -->
        <div class="mt-10 p-6 bg-indigo-50 rounded-xl shadow-inner">
            <h2 class="text-2xl font-bold text-indigo-600 mb-4 text-center">Derived Statistics Summary</h2>
            <div id="stats-summary" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Dynamic stats will be injected here -->
                <div class="bg-white p-4 rounded-lg shadow-sm border border-indigo-200">
                    <p class="text-sm text-gray-500">A-Maneuver</p>
                    <p id="summary-a-maneuver" class="text-xl font-semibold text-gray-900">--</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-indigo-200">
                    <p class="text-sm text-gray-500">Turn Radius (hexes)</p>
                    <p id="summary-turn-radius" class="text-xl font-semibold text-gray-900">--</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-indigo-200">
                    <p class="text-sm text-gray-500">Speed (hexes)</p>
                    <p id="summary-speed" class="text-xl font-semibold text-gray-900">--</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-indigo-200">
                    <p class="text-sm text-gray-500">Armor Points</p>
                    <p id="summary-armor-points" class="text-xl font-semibold text-gray-900">--</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-indigo-200">
                    <p class="text-sm text-gray-500">Armor Mass (tons)</p>
                    <p id="summary-armor-mass" class="text-xl font-semibold text-gray-900">--</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-indigo-200">
                    <p class="text-sm text-gray-500">Armor Cost (MCr)</p>
                    <p id="summary-armor-cost" class="text-xl font-semibold text-gray-900">--</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-indigo-200">
                    <p class="text-sm text-gray-500">Allocated Mass (tons)</p>
                    <p id="summary-allocated-mass" class="text-xl font-semibold text-gray-900">--</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-indigo-200">
                    <p class="text-sm text-gray-500">Total Final Cost (MCr)</p>
                    <p id="summary-total-cost" class="text-xl font-semibold text-gray-900">--</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-indigo-200">
                    <p class="text-sm text-gray-500">Jump Drive Rating</p>
                    <p id="summary-jump-drive-rating" class="text-xl font-semibold text-gray-900">--</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-indigo-200">
                    <p class="text-sm text-gray-500">Maneuver Drive Rating</p>
                    <p id="summary-maneuver-drive-rating" class="text-xl font-semibold text-gray-900">--</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-indigo-200">
                    <p class="text-sm text-gray-500">Design Cost (MCr)</p>
                    <p id="summary-design-cost" class="text-xl font-semibold text-gray-900">--</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-indigo-200">
                    <p class="text-sm text-gray-500">Calculated Cargo (tons)</p>
                    <p id="summary-calculated-cargo" class="text-xl font-semibold text-gray-900">--</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal Structure for Missing Data -->
    <div id="missing-data-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-indigo-600 mb-4">Missing Ship Data</h2>
            <p class="text-gray-700 mb-6">Please provide the missing information to proceed with calculations:</p>
            <div id="modal-inputs" class="space-y-4">
                <!-- Dynamic input fields will be inserted here -->
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancel</button>
                <button id="modal-submit-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Submit</button>
            </div>
        </div>
    </div>

    <!-- Modal Structure for Adding Rooms -->
    <div id="add-room-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-green-600 mb-4">Add Additional Room</h2>
            <div class="space-y-4">
                <div class="flex flex-col">
                    <label for="room-name-input" class="block text-sm font-medium text-gray-700 mb-1">Room Name</label>
                    <input type="text" id="room-name-input" class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="e.g., Medical Bay">
                </div>
                <div class="flex flex-col">
                    <label for="room-tonnage-input" class="block text-sm font-medium text-gray-700 mb-1">Room Tonnage</label>
                    <input type="number" id="room-tonnage-input" class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="e.g., 5">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="add-another-room-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Another</button>
                <button id="done-adding-rooms-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Done</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // SINGLE SOURCE OF TRUTH FOR ARMOR DATA
            const ARMOR_DATA = [
                { grade: 'n', points: 2, mass: 0, mass_small: 0, cost: 0, notes: 'Default for 10-99t' },
                { grade: 'A', points: 3, mass: 5, mass_small: 2, cost: 10 },
                { grade: 'B', points: 4, mass: 10, mass_small: 4, cost: 20, notes: 'Default for 100-300t' },
                { grade: 'C', points: 5, mass: 15, mass_small: 6, cost: 30 },
                { grade: 'D', points: 6, mass: 20, mass_small: 8, cost: 40, notes: 'Default for 400-700t' },
                { grade: 'E', points: 7, mass: 25, mass_small: 10, cost: 50 },
                { grade: 'F', points: 8, mass: 30, mass_small: 12, cost: 60, notes: 'Default for 800-1000t' },
                { grade: 'G', points: 9, mass: 35, mass_small: 14, cost: 70 },
                { grade: 'H', points: 10, mass: 40, mass_small: 16, cost: 80, notes: 'Default for 1000+t, max for small ships' },
                { grade: 'J', points: 15, mass: 60, cost: 90 },
                { grade: 'K', points: 20, mass: 80, cost: 100 },
                { grade: 'L', points: 25, mass: 100, cost: 110 },
                { grade: 'M', points: 30, mass: 120, cost: 120 },
                { grade: 'N', points: 40, mass: 140, cost: 130 },
                { grade: 'P', points: 50, mass: 160, cost: 140 },
                { grade: 'Q', points: 60, mass: 180, cost: 150 },
                { grade: 'R', points: 90, mass: 230, cost: 160, military: true },
                { grade: 'T', points: 120, mass: 280, cost: 180, military: true },
                { grade: 'U', points: 150, mass: 330, cost: 190, military: true },
                { grade: 'V', points: 200, mass: 380, cost: 200, military: true },
                { grade: 'W', points: 250, mass: 480, cost: 210, military: true },
                { grade: 'X', points: 300, mass: 580, cost: 220, military: true },
                { grade: 'Y', points: 350, mass: 680, cost: 230, military: true },
                { grade: 'Z', points: 400, mass: 780, cost: 240, military: true }
            ];

            const jsonInput = document.getElementById('json-input');
            const jsonOutput = document.getElementById('json-output');
            const calculateBtn = document.getElementById('calculate-btn');
            const messageBox = document.getElementById('message-box');
            const missingDataModal = document.getElementById('missing-data-modal');
            const modalSubmitBtn = document.getElementById('modal-submit-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');

            const addRoomBtn = document.getElementById('add-room-btn');
            const addRoomModal = document.getElementById('add-room-modal');
            const roomNameInput = document.getElementById('room-name-input');
            const roomTonnageInput = document.getElementById('room-tonnage-input');
            const addAnotherRoomBtn = document.getElementById('add-another-room-btn');
            const doneAddingRoomsBtn = document.getElementById('done-adding-rooms-btn');

            // Global variable to store shipData for modal interaction
            let currentShipData = {};

            // Populate armor reference table from ARMOR_DATA
            const populateArmorTable = () => {
                const armorTableBody = document.getElementById('armor-table-body');
                const armorData = ARMOR_DATA;

                armorData.forEach(armor => {
                    const row = document.createElement('tr');
                    row.className = armor.military ? 'bg-red-50' : (armor.notes ? 'bg-blue-50' : '');
                    
                    const smallMassDisplay = armor.mass_small !== undefined ? armor.mass_small : '--';
                    
                    row.innerHTML = `
                        <td class="py-2 px-2 font-semibold ${armor.military ? 'text-red-700' : ''}">${armor.grade}${armor.notes ? '*' : ''}</td>
                        <td class="py-2 px-2 text-right">${armor.points}</td>
                        <td class="py-2 px-2 text-right">${armor.mass}</td>
                        <td class="py-2 px-2 text-right">${smallMassDisplay}</td>
                        <td class="py-2 px-2 text-right">${armor.cost}</td>
                    `;
                    
                    if (armor.notes) {
                        row.title = armor.notes;
                    }
                    
                    armorTableBody.appendChild(row);
                });
            };

            // Call the function to populate the table on page load
            populateArmorTable();

            // Set the default JSON input with the user's example
            jsonInput.value = JSON.stringify({
                "hull_tonnage": 100,
                "jump_drive": {
                    "drive_letter": "A",
                    "mass_tons": null,
                    "cost_mcr": null,
                    "drive_rating": 2
                },
                "maneuver_drive": {
                    "drive_letter": "A",
                    "mass_tons": 1,
                    "cost_mcr": 4,
                    "drive_rating": 2
                },
                "power_plant": {
                    "drive_letter": "A",
                    "mass_tons": 4,
                    "cost_mcr": 8
                },
                "computer": {
                    "model": "1",
                    "mcr": 2,
                    "tons": 1,
                    "cpu_capacity": 2,
                    "storage_capacity": 4,
                    "tl": 5
                },
                "staterooms": 2,
                "low_berths": 0,
                "armament": [],
                "fuel_tons": 20,
                "cargo_tons": 36,
                "isStreamlined": false,
                "notes": "",
                "armor": {},
                "crew_requirements": [
                    "Pilot",
                    "Engineer"
                ],
                "bridge_skills": [],
                "gunner_skills": [],
                "programs": [],
                "additional_rooms": []
            }, null, 2);

            const displayMessage = (message, type = 'info') => {
                messageBox.textContent = message;
                messageBox.className = `mt-4 p-4 rounded-lg text-sm opacity-100 ${
                    type === 'error' ? 'bg-red-100 text-red-700' :
                    type === 'warning' ? 'bg-yellow-100 text-yellow-700' :
                    'bg-green-100 text-green-700'
                }`;
            };

            const clearMessage = () => {
                messageBox.textContent = '';
                messageBox.className = 'mt-4 p-4 rounded-lg text-sm opacity-0';
            };

            // Helper to get nested value
            const getNestedValue = (obj, path) => {
                return path.split('.').reduce((acc, part) => acc && acc[part], obj);
            };

            // Helper to set nested value
            const setNestedValue = (obj, path, value) => {
                const parts = path.split('.');
                let current = obj;
                for (let i = 0; i < parts.length - 1; i++) {
                    if (!current[parts[i]]) {
                        current[parts[i]] = {};
                    }
                    current = current[parts[i]];
                }
                current[parts[parts.length - 1]] = value;
            };

            const showModal = (modalElement, missingFields = []) => {
                const modalInputsDiv = modalElement.querySelector('#modal-inputs');
                if (!modalInputsDiv) {
                    console.error('Modal input container not found for:', modalElement.id);
                    return;
                }
                modalInputsDiv.innerHTML = '';

                if (modalElement.id === 'missing-data-modal') {
                    console.log('Preparing missing data modal for fields:', missingFields);

                    const missingListContainer = document.createElement('div');
                    missingListContainer.className = 'mb-4';

                    const missingListHeader = document.createElement('p');
                    missingListHeader.className = 'font-semibold text-gray-800';
                    missingListHeader.textContent = 'The following required fields are missing:';
                    missingListContainer.appendChild(missingListHeader);

                    const missingList = document.createElement('ul');
                    missingList.className = 'list-disc list-inside text-red-700 mt-2';
                    missingFields.forEach(field => {
                        const listItem = document.createElement('li');
                        listItem.textContent = field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        missingList.appendChild(listItem);
                    });
                    missingListContainer.appendChild(missingList);
                    modalInputsDiv.appendChild(missingListContainer);

                    missingFields.forEach(field => {
                        console.log(`Dynamically creating input for: ${field}`);
                        let labelText = field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        let inputType = 'text';

                        if (field.includes('tonnage') || field.includes('mass') || field.includes('cost') || field.includes('staterooms') || field.includes('capacity') || field.includes('tl') || field.includes('rating') || field.includes('berths')) {
                            inputType = 'number';
                        } else if (field.includes('isStreamlined')) {
                            inputType = 'checkbox';
                        }

                        const inputGroup = document.createElement('div');
                        inputGroup.className = 'flex flex-col';

                        const label = document.createElement('label');
                        label.htmlFor = `modal-input-${field}`;
                        label.className = 'block text-sm font-medium text-gray-700 mb-1';
                        label.textContent = labelText;
                        inputGroup.appendChild(label);

                        const input = document.createElement('input');
                        input.type = inputType;
                        input.id = `modal-input-${field}`;
                        input.name = field;
                        input.className = 'p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500';
                        input.required = true;

                        let value = getNestedValue(currentShipData, field);
                        if (value !== undefined && value !== null) {
                            if (inputType === 'checkbox') {
                                input.checked = value;
                            } else {
                                input.value = value;
                            }
                        }

                        inputGroup.appendChild(input);
                        modalInputsDiv.appendChild(inputGroup);
                        console.log(`Input created and appended for: ${field}`);
                    });
                }

                modalElement.classList.remove('hidden');
                modalElement.style.zIndex = '1000';
                console.log('Modal visibility set to true for:', modalElement.id);
            };

            const hideModal = (modalElement) => {
                modalElement.classList.add('hidden');
            };

            // Event listener for modal submit (for missing data)
            modalSubmitBtn.addEventListener('click', () => {
                const modalInputsDiv = document.getElementById('modal-inputs');
                const inputs = modalInputsDiv.querySelectorAll('input');
                let allFilled = true;

                inputs.forEach(input => {
                    let value;
                    if (input.type === 'number') {
                        value = parseFloat(input.value);
                        if (isNaN(value)) {
                            allFilled = false;
                            input.classList.add('border-red-500');
                        } else {
                            input.classList.remove('border-red-500');
                            setNestedValue(currentShipData, input.name, value);
                        }
                    } else if (input.type === 'checkbox') {
                        value = input.checked;
                        setNestedValue(currentShipData, input.name, value);
                    } else {
                        value = input.value.trim();
                        if (value === '') {
                            allFilled = false;
                            input.classList.add('border-red-500');
                        } else {
                            input.classList.remove('border-red-500');
                            setNestedValue(currentShipData, input.name, value);
                        }
                    }
                });

                if (allFilled) {
                    hideModal(missingDataModal);
                    jsonInput.value = JSON.stringify(currentShipData, null, 2);
                    calculateStatistics();
                } else {
                    displayMessage('Please fill in all required fields.', 'error');
                }
            });

            modalCancelBtn.addEventListener('click', () => {
                hideModal(missingDataModal);
                displayMessage('Calculation cancelled. Please provide complete data to proceed.', 'warning');
            });

            // Event listeners for adding rooms
            addRoomBtn.addEventListener('click', () => {
                showModal(addRoomModal);
                roomNameInput.value = '';
                roomTonnageInput.value = '';
            });

            const addRoom = () => {
                const name = roomNameInput.value.trim();
                const tonnage = parseFloat(roomTonnageInput.value);

                if (!name || isNaN(tonnage) || tonnage <= 0) {
                    displayMessage('Please enter a valid room name and a positive tonnage.', 'error');
                    return false;
                }

                if (!currentShipData.additional_rooms) {
                    currentShipData.additional_rooms = [];
                }
                currentShipData.additional_rooms.push({ name: name, tonnage: tonnage });
                displayMessage(`Added room: ${name} (${tonnage} tons)`, 'info');
                return true;
            };

            addAnotherRoomBtn.addEventListener('click', () => {
                if (addRoom()) {
                    roomNameInput.value = '';
                    roomTonnageInput.value = '';
                    roomNameInput.focus();
                }
            });

            doneAddingRoomsBtn.addEventListener('click', () => {
                if (roomNameInput.value.trim() !== '' || !isNaN(parseFloat(roomTonnageInput.value))) {
                    addRoom();
                }
                hideModal(addRoomModal);
                jsonInput.value = JSON.stringify(currentShipData, null, 2);
                calculateStatistics();
            });

            // Define the lookup tables and rules
            const rules = {
                mDriveSpeed: (tonnage, driveLetter, driveRating) => {
                    // For large craft (100+ tons), use the drive_rating directly
                    if (tonnage >= 100) {
                        return driveRating !== undefined && driveRating !== null ? driveRating : 0;
                    }
                    
                    // Speed table for small craft
                    const speedTable = {
                        '10-39': { 'A': 6, 'B': 8, 'C': 10 },
                        '40-95': { 'A': 4, 'B': 6, 'C': 8 }
                    };
                    
                    // Determine which range the small craft falls into
                    let range;
                    let maxSpeed;
                    if (tonnage >= 10 && tonnage <= 39) {
                        range = '10-39';
                        maxSpeed = 10; // Cap at 10G
                    } else if (tonnage >= 40 && tonnage <= 95) {
                        range = '40-95';
                        maxSpeed = 8; // Cap at 8G
                    } else {
                        return 0; // Invalid tonnage
                    }
                    
                    // Get speed from table, or cap at max if drive is D or higher
                    const speedValue = speedTable[range][driveLetter];
                    if (speedValue !== undefined) {
                        return speedValue;
                    } else {
                        // For drives D, E, F, etc. - cap at max speed for this tonnage range
                        return maxSpeed;
                    }
                },

                aManeuverDM: (tonnage) => {
                    if (tonnage >= 10 && tonnage <= 19) return "+2";
                    if (tonnage >= 20 && tonnage <= 39) return "+1";
                    if (tonnage >= 40 && tonnage <= 99) return "0";
                    if (tonnage >= 100 && tonnage <= 500) return "-1";
                    if (tonnage > 500) return "-2";
                    return "--";
                },

                turnRadius: (tonnage, driveLetter) => {
                    const letterMap = { 'A': 0, 'B': 1, 'C': 2, 'D': 3, 'E': 4, 'F': 5 };
                    const trTable = {
                        '10-39': [3, 2, 1, 'X', 'X', 'X'],
                        '40-99': [6, 3, 2, 'X', 'X', 'X'],
                        '100-199': [12, 6, 4, 'X', 'X', 'X'],
                        '200-399': [24, 12, 8, 6, 5, 5],
                        '400-599': ['X', 24, 24, 12, 8, 6],
                        '600-799': ['X', 'X', 24, 24, 24, 12],
                    };
                    const letterIndex = letterMap[driveLetter];
                    if (tonnage >= 10 && tonnage <= 39 && letterIndex !== undefined) {
                        return trTable['10-39'][letterIndex];
                    }
                    if (tonnage >= 40 && tonnage <= 99 && letterIndex !== undefined) {
                        return trTable['40-99'][letterIndex];
                    }
                    if (tonnage >= 100 && tonnage <= 199 && letterIndex !== undefined) {
                        return trTable['100-199'][letterIndex];
                    }
                    if (tonnage >= 200 && tonnage <= 399 && letterIndex !== undefined) {
                        return trTable['200-399'][letterIndex];
                    }
                    if (tonnage >= 400 && tonnage <= 599 && letterIndex !== undefined) {
                        return trTable['400-599'][letterIndex];
                    }
                    if (tonnage >= 600 && tonnage <= 799 && letterIndex !== undefined) {
                        return trTable['600-799'][letterIndex];
                    }
                    if (tonnage >= 800) {
                        return 24;  // Number, not string
                    }
                    return "--";  // Fallback
                },

                defaultArmor: (tonnage) => {
                    if (tonnage >= 10 && tonnage <= 99) return 'n';
                    if (tonnage >= 100 && tonnage <= 300) return 'B';
                    if (tonnage >= 400 && tonnage <= 700) return 'D';
                    if (tonnage >= 800 && tonnage <= 1000) return 'F';
                    if (tonnage > 1000) return 'H';
                    return null;
                },
                
                armorPoints: (armorLetter) => {
                    const armor = ARMOR_DATA.find(a => a.grade === armorLetter);
                    return armor ? armor.points : 'NA';
                },

                getArmorGradeIndex: (armorLetter) => {
                    return ARMOR_DATA.findIndex(a => a.grade === armorLetter);
                },

                armorStatsBaseValue: (armorLetter, isSmallShip) => {
                    const armor = ARMOR_DATA.find(a => a.grade === armorLetter);
                    if (!armor) return { cost_mcr: 0, mass_tons: 0 };
                    
                    // Use different mass for small ships
                    const mass = isSmallShip ? (armor.mass_small !== undefined ? armor.mass_small : armor.mass) : armor.mass;
                    return { cost_mcr: armor.cost, mass_tons: mass };
                }
            };
            
            const staticComponentCosts = {
                'bridge_mass': 20.00,
                'stateroom_mass': 4,
                'hardpoint_mass_per_unit': 1
            };

            const calculateStatistics = () => {
                clearMessage();
                try {
                    currentShipData = JSON.parse(jsonInput.value);
                    const hullTonnage = currentShipData.hull_tonnage;
                    const isSmallShip = hullTonnage < 100;

                    if (!currentShipData.bridge_skills) currentShipData.bridge_skills = [];
                    if (!currentShipData.gunner_skills) currentShipData.gunner_skills = [];
                    if (!currentShipData.programs) currentShipData.programs = [];
                    if (!currentShipData.additional_rooms) currentShipData.additional_rooms = [];
                    if (!currentShipData.armor) currentShipData.armor = { "armor_letter": null };
                    if (!currentShipData.jump_drive) currentShipData.jump_drive = { "drive_letter": null, "mass_tons": null, "cost_mcr": null, "drive_rating": null };
                    if (!currentShipData.maneuver_drive) currentShipData.maneuver_drive = { "drive_letter": null, "mass_tons": null, "cost_mcr": null, "drive_rating": null };
                    if (!currentShipData.power_plant) currentShipData.power_plant = { "drive_letter": null, "mass_tons": null, "cost_mcr": null };
                    if (!currentShipData.computer) currentShipData.computer = { "model": null, "mcr": null, "tons": null, "cpu_capacity": null, "storage_capacity": null, "tl": null };
                    if (currentShipData.staterooms === undefined || currentShipData.staterooms === null) currentShipData.staterooms = 0;
                    if (currentShipData.fuel_tons === undefined || currentShipData.fuel_tons === null) currentShipData.fuel_tons = 0;
                    if (currentShipData.low_berths === undefined || currentShipData.low_berths === null) currentShipData.low_berths = 0;
                    const originalCargoTons = currentShipData.cargo_tons === undefined || currentShipData.cargo_tons === null ? 0 : currentShipData.cargo_tons;

                    const missingFields = [];

                    const requiredFields = [
                        'hull_tonnage',
                        'jump_drive.drive_letter',
                        'jump_drive.drive_rating',
                        'maneuver_drive.drive_letter',
                        'maneuver_drive.drive_rating',
                        'power_plant.drive_letter',
                        'computer.model',
                        'staterooms',
                        'fuel_tons',
                        'cargo_tons',
                        'armor.armor_letter',
                        'low_berths'
                    ];

                    requiredFields.forEach(field => {
                        const value = getNestedValue(currentShipData, field);
                        if (value === undefined || value === null || (typeof value === 'string' && value.trim() === '')) {
                            missingFields.push(field);
                        }
                    });

                    if (missingFields.length > 0) {
                        displayMessage('Some required ship data is missing. Please provide it.', 'warning');
                        console.log('Missing fields detected:', missingFields);
                        showModal(missingDataModal, missingFields);
                        return;
                    } else {
                        console.log('No missing fields detected. Proceeding with calculation.');
                    }

                    const derivedStats = {
                        'aManeuverDM': rules.aManeuverDM(hullTonnage),
                        'turnRadius': rules.turnRadius(hullTonnage, currentShipData.maneuver_drive.drive_letter),
                        'speedHexes': rules.mDriveSpeed(hullTonnage, currentShipData.maneuver_drive.drive_letter, currentShipData.maneuver_drive.drive_rating),
                        'jump_drive_rating': currentShipData.jump_drive.drive_rating,
                        'maneuver_drive_rating': currentShipData.maneuver_drive.drive_rating,
                    };

                    const defaultArmorLetter = rules.defaultArmor(hullTonnage);
                    let armorLetter = currentShipData.armor?.armor_letter;

                    if (!armorLetter) {
                        armorLetter = defaultArmorLetter;
                        currentShipData.armor.armor_letter = armorLetter;
                    }

                    const armorPoints = armorLetter ? rules.armorPoints(armorLetter) : '--';
                    
                    let armorMass = 0;
                    let armorCost = 0;

                    if (armorLetter) {
                        const chosenArmorIndex = rules.getArmorGradeIndex(armorLetter);
                        const defaultArmorIndex = rules.getArmorGradeIndex(defaultArmorLetter);

                        if (chosenArmorIndex > defaultArmorIndex) {
                             const chosenArmorBaseStats = rules.armorStatsBaseValue(armorLetter, isSmallShip);
                             const defaultArmorBaseStats = rules.armorStatsBaseValue(defaultArmorLetter, isSmallShip); 

                             armorMass = chosenArmorBaseStats.mass_tons - defaultArmorBaseStats.mass_tons;
                             armorCost = chosenArmorBaseStats.cost_mcr;

                             if (['R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'].includes(armorLetter)) {
                                displayMessage(`Warning: Armor grade '${armorLetter}' is typically military/experimental and not available for purchase.`, 'warning');
                             }
                        }
                    }
                    currentShipData.armor.armor_mass = armorMass;
                    currentShipData.armor.armor_cost = armorCost;
                    
                    // Calculate allocated mass (sum of all components)
                    const armamentMass = currentShipData.armament.length * staticComponentCosts.hardpoint_mass_per_unit;

                    // Start with user's original cargo value
                    let availableCargoSpace = originalCargoTons;
                    
                    // Only subtract armor mass
                    availableCargoSpace -= armorMass;
                    
                    // Only subtract additional rooms
                    if (currentShipData.additional_rooms && currentShipData.additional_rooms.length > 0) {
                        currentShipData.additional_rooms.forEach(room => {
                            availableCargoSpace -= room.tonnage;
                        });
                    }

                    let finalCalculatedCargoTons;
                    let finalAllocatedMass;

                    if (availableCargoSpace < 0) {
                        finalCalculatedCargoTons = 0;
                        finalAllocatedMass = hullTonnage;
                        displayMessage(`Critical Warning: Armor and additional rooms exceed available cargo space. No cargo space remaining.`, 'error');
                    } else {
                        finalCalculatedCargoTons = availableCargoSpace;
                        finalAllocatedMass = hullTonnage;
                    }

                    if (originalCargoTons > finalCalculatedCargoTons) {
                         displayMessage(`Warning: Specified cargo (${originalCargoTons} tons) exceeds available hull space. Cargo capped at ${finalCalculatedCargoTons.toFixed(2)} tons.`, 'warning');
                    }

                    // Preserve existing calculated_statistics, only add/update derived combat stats
                    if (!currentShipData.calculated_statistics) {
                        currentShipData.calculated_statistics = {};
                    }

                    // Add only derived combat/performance statistics
                    currentShipData.calculated_statistics = {
                        ...currentShipData.calculated_statistics, // Preserve all existing values
                        ...derivedStats, // Add combat stats
                        armor_points: armorPoints,
                        armor_mass: armorMass,
                        armor_cost: armorCost,
                        armament_mass: armamentMass,
                        allocated_mass: parseFloat(finalAllocatedMass.toFixed(2)),
                        calculated_cargo_tons: parseFloat(finalCalculatedCargoTons.toFixed(2)),
                        is_small_ship: isSmallShip
                    };

                    jsonOutput.value = JSON.stringify(currentShipData, null, 2);
                    displayMessage('Statistics calculated successfully!', 'success');
                    
                    // Update summary displays - use existing values if available
                    document.getElementById('summary-a-maneuver').textContent = derivedStats.aManeuverDM;
                    document.getElementById('summary-turn-radius').textContent = derivedStats.turnRadius;
                    document.getElementById('summary-speed').textContent = derivedStats.speedHexes;
                    document.getElementById('summary-allocated-mass').textContent = currentShipData.calculated_statistics.allocated_mass.toFixed(2);
                    document.getElementById('summary-armor-points').textContent = armorPoints;
                    document.getElementById('summary-armor-mass').textContent = armorMass.toFixed(2);
                    document.getElementById('summary-armor-cost').textContent = armorCost.toFixed(2);
                    document.getElementById('summary-jump-drive-rating').textContent = derivedStats.jump_drive_rating;
                    document.getElementById('summary-maneuver-drive-rating').textContent = derivedStats.maneuver_drive_rating;
                    document.getElementById('summary-calculated-cargo').textContent = currentShipData.calculated_statistics.calculated_cargo_tons.toFixed(2);
                    
                    // Display user-provided values if they exist
                    const totalCost = currentShipData.calculated_statistics?.total_final_cost;
                    const designCost = currentShipData.calculated_statistics?.design_cost;
                    document.getElementById('summary-total-cost').textContent = totalCost ? parseFloat(totalCost).toFixed(2) : '--';
                    document.getElementById('summary-design-cost').textContent = designCost ? parseFloat(designCost).toFixed(2) : '--';
                
                } catch (e) {
                    displayMessage(`Error processing JSON: ${e.message}. Please ensure your JSON is valid.`, 'error');
                }
            };

            calculateBtn.addEventListener('click', calculateStatistics);
        });
    </script>
</body>
</html>


